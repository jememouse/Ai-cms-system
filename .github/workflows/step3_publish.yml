name: Step3 - RPA 发布到 WellCMS

on:
  schedule:
    # 北京时间 08:00 - 23:00 每1小时执行 -> UTC 00:00 - 15:00
    - cron: '0 0-15 * * *'
  workflow_dispatch:  # 允许手动触发

jobs:
  step3-publish:
    runs-on: ubuntu-latest
    timeout-minutes: 25          # 25分钟超时（留5分钟buffer）
    concurrency:
      group: step3-publish
      cancel-in-progress: false  # 跳过新任务，不取消正在运行的
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        enable-cache: true

    - name: Install dependencies
      run: uv sync

    - name: Install Playwright browsers
      run: uv run playwright install chromium --with-deps

    - name: Run Step3 - RPA 发布
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
        FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
        FEISHU_BASE_ID: ${{ secrets.FEISHU_BASE_ID }}
        FEISHU_TABLE_ID: ${{ secrets.FEISHU_TABLE_ID }}
        WELLCMS_USERNAME: ${{ secrets.WELLCMS_USERNAME }}
        WELLCMS_PASSWORD: ${{ secrets.WELLCMS_PASSWORD }}
        PUBLISH_CONFIG_JSON: ${{ secrets.PUBLISH_CONFIG_JSON }}
        # Google Sheets Config
        GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
        GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
        # Image API Keys
        POLLINATIONS_API_KEYS: ${{ secrets.POLLINATIONS_API_KEYS }}
        PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
        PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
        TZ: 'Asia/Shanghai'
      run: |
        uv run python -m step3_publish.agent_runner
