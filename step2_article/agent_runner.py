import sys
import os
import json
import time

sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from agents.chief_editor import ChiefEditorAgent
from shared.feishu_client import FeishuClient
from shared import config

def run():
    print("\n" + "=" * 50)
    print("ğŸ¤– å¯åŠ¨ Agentic Workflow (Step 2: Article Gen)")
    print("=" * 50 + "\n")
    
    # Init
    editor = ChiefEditorAgent()
    client = FeishuClient()
    
    # Load Topics (Generated by Step 1)
    # å®é™…ç”Ÿäº§ä¸­åº”è¯¥ä»é£ä¹¦è¯» Pending çŠ¶æ€çš„è®°å½•ï¼Œæˆ–è€…ä» json æ–‡ä»¶è¯»
    # è¿™é‡Œæ¼”ç¤ºä» generated_seo_data.json è¯»ï¼Œå¹¶æ¨¡æ‹Ÿå†™å…¥é£ä¹¦
    
    BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
    INPUT_FILE = os.path.join(BASE_DIR, 'generated_seo_data.json')
    
    if not os.path.exists(INPUT_FILE):
        print("âŒ æœªæ‰¾åˆ°é€‰é¢˜æ–‡ä»¶ï¼Œè¯·å…ˆè¿è¡Œ Step 1")
        return
        
    with open(INPUT_FILE, 'r', encoding='utf-8') as f:
        topics = json.load(f)
        
    # è¿‡æ»¤ Pending
    pending_topics = [t for t in topics if t.get('Status') == 'Pending']
    print(f"ğŸ“‹ å‘ç° {len(pending_topics)} ä¸ªå¾…å†™é€‰é¢˜")
    
    for item in pending_topics[:5]: # æ¼”ç¤ºåªè·‘5ä¸ª
        article = editor.write_article(item['Topic'], item['å¤§é¡¹åˆ†ç±»'])
        
        if article:
            # Save to Feishu (System Action)
            # åŒæ ·ï¼ŒAgent åªè´Ÿè´£äº§å‡ºï¼ŒIOç”±ç³»ç»Ÿå±‚è´Ÿè´£
            record = {
                "Topic": item['Topic'],
                "Title": article.get('title'),
                "HTML_Content": article.get('html_content'),
                "Category": item['å¤§é¡¹åˆ†ç±»'],
                "Status": "Generated", # å¾…å‘å¸ƒ
                "Keywords": article.get('keywords'),
                "Summary": article.get('summary'),
                "Description": article.get('description'),
                "Tags": article.get('tags'),
                "One_Line_Summary": article.get('one_line_summary'),
                "Schema_FAQ": json.dumps(article.get('schema_faq', []), ensure_ascii=False)
            }
            res_id = client.create_record(record)
            if res_id:
                print(f"   ğŸ’¾ å·²ä¿å­˜è‡³é£ä¹¦ (ID: {res_id})")
                item['Status'] = 'Done' # Update local status
        
        time.sleep(2)
        
    # Update JSON
    with open(INPUT_FILE, 'w', encoding='utf-8') as f:
        json.dump(topics, f, ensure_ascii=False, indent=2)

if __name__ == "__main__":
    run()
