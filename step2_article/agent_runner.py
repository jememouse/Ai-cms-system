import sys
import os
import json
import time

sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from agents.chief_editor import ChiefEditorAgent
from shared.feishu_client import FeishuClient
from shared import config

def run():
    print("\n" + "=" * 50)
    print("ğŸ¤– å¯åŠ¨ Agentic Workflow (Step 2: Article Gen)")
    print("=" * 50 + "\n")
    
    # Init
    editor = ChiefEditorAgent()
    client = FeishuClient()
    
    # Load Topics (Generated by Step 1)
    # å®é™…ç”Ÿäº§ä¸­åº”è¯¥ä»é£ä¹¦è¯» Pending çŠ¶æ€çš„è®°å½•ï¼Œæˆ–è€…ä» json æ–‡ä»¶è¯»
    # è¿™é‡Œæ¼”ç¤ºä» generated_seo_data.json è¯»ï¼Œå¹¶æ¨¡æ‹Ÿå†™å…¥é£ä¹¦
    
    BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
    INPUT_FILE = os.path.join(BASE_DIR, 'generated_seo_data.json')
    
    if not os.path.exists(INPUT_FILE):
        print("âŒ æœªæ‰¾åˆ°é€‰é¢˜æ–‡ä»¶ï¼Œè¯·å…ˆè¿è¡Œ Step 1")
        return
        
    with open(INPUT_FILE, 'r', encoding='utf-8') as f:
        topics = json.load(f)
        
    # è¿‡æ»¤ Ready (User Requirement: æ ‡é¢˜ç”Ÿæˆæ˜¯ "Ready")
    pending_topics = [t for t in topics if t.get('Status') == 'Ready']
    print(f"ğŸ“‹ å‘ç° {len(pending_topics)} ä¸ª Ready é€‰é¢˜")
    
    # Load Config Limit
    max_limit = config.MAX_GENERATE_PER_CATEGORY
    print(f"âš™ï¸  æ¯åˆ†ç±»å¤„ç†ä¸Šé™: {max_limit}")

    # 3. åˆ†ç»„ä¸ Round-Robin æ’åº
    # Group by Category
    from collections import defaultdict
    grouped_topics = defaultdict(list)
    for t in pending_topics:
        cat = t.get('å¤§é¡¹åˆ†ç±»', 'æœªåˆ†ç±»')
        grouped_topics[cat].append(t)
    
    print("ğŸ“Š å¾…å¤„ç†é€‰é¢˜åˆ†å¸ƒ:")
    for cat, items in grouped_topics.items():
        print(f"   - {cat}: {len(items)} æ¡")
        
    # Round-Robin Merge
    # [CatA_1, CatB_1, CatC_1, CatA_2, ...]
    sorted_topics = []
    from itertools import zip_longest
    # å–æ¯ä¸ªåˆ†ç±»çš„å‰ max_limit æ¡
    lists = [items[:max_limit] for items in grouped_topics.values()]
    
    for items in zip_longest(*lists):
        for item in items:
            if item is not None:
                sorted_topics.append(item)
                
    print(f"ğŸ”„ å‡è¡¡æ’åºåå…± {len(sorted_topics)} æ¡ä»»åŠ¡")
    
    import random
    from datetime import datetime
    
    # 4. Execute
    for idx, item in enumerate(sorted_topics):
        print(f"\n--- [{idx + 1}/{len(sorted_topics)}] {item['å¤§é¡¹åˆ†ç±»']} | {item['Topic'][:30]}... ---")
        
        article = editor.write_article(item['Topic'], item['å¤§é¡¹åˆ†ç±»'])
        
        if article:
            # Save to Feishu (System Action)
            # åŒæ ·ï¼ŒAgent åªè´Ÿè´£äº§å‡ºï¼ŒIOç”±ç³»ç»Ÿå±‚è´Ÿè´£
            current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            record = {
                "Topic": item['Topic'],
                "Title": article.get('title'),
                "HTML_Content": article.get('html_content'),
                "å¤§é¡¹åˆ†ç±»": item['å¤§é¡¹åˆ†ç±»'],
                "Status": config.STATUS_PENDING, # User Requirement: æ–‡ç« ç”Ÿæˆä¸º "Pending"
                "å…³é”®è¯": article.get('keywords'),
                "æ‘˜è¦": article.get('summary'),
                "æè¿°": article.get('description'),
                "Tags": article.get('tags'),
                "ç”Ÿæˆæ—¶é—´": current_time, # User Requirement: æ¯ä¸ªçŠ¶æ€çš„æ—¶é—´è¦æ’å…¥å¯¹åº”çš„å•å…ƒæ ¼
                "Tags": article.get('tags'),
                "ç”Ÿæˆæ—¶é—´": current_time, # æ–‡ç« ç”Ÿæˆæ—¶é—´
                "é€‰é¢˜ç”Ÿæˆæ—¶é—´": item.get('created_at', ''), # Step 1 äº§ç”Ÿçš„æ—¶é—´
                "One_Line_Summary": article.get('one_line_summary', ''),
                "Schema_FAQ": json.dumps(article.get('schema_faq', []), ensure_ascii=False),
                "Key_Points": json.dumps(article.get('key_points', []), ensure_ascii=False)
            }
            res_id = client.create_record(record)
            if res_id:
                print(f"   ğŸ’¾ å·²ä¿å­˜è‡³é£ä¹¦ (ID: {res_id}, Status: Pending)")
                item['Status'] = 'Pending' # Update local status
        
        # Random Interval
        # Optimization: 5-10s to avoid rate limit
        wait_time = random.uniform(5, 10)
        print(f"   â³ ç­‰å¾… {wait_time:.1f} ç§’...")
        time.sleep(wait_time)
        
    # Update JSON
    with open(INPUT_FILE, 'w', encoding='utf-8') as f:
        json.dump(topics, f, ensure_ascii=False, indent=2)

if __name__ == "__main__":
    run()
